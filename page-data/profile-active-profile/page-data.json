{"componentChunkName":"component---src-templates-blog-template-js","path":"/profile-active-profile/","result":{"data":{"cur":{"id":"d5d76813-7bae-5b9a-b7c6-1a21a2637ac2","html":"<h2 id=\"intro\" style=\"position:relative;\"><a href=\"#intro\" aria-label=\"intro permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Intro</h2>\n<hr>\n<br>\n<ul>\n<li>프로젝트를 진행하다 보면 상황에 따라 각기 다른 운영환경을 설정해야할때가 있다. 그때마다 properties 설정 파일에 가서 설정되어있는 운영 환경을 바꾸고 돌리기는 어렵다. </li>\n<li>이때 각기 다른 <code class=\"language-text\">Profile</code>를 적용해서 상황에 따라 적합한 <code class=\"language-text\">Profile</code> 설정을 따르도록 할 수 있다. </li>\n</ul>\n<br>\n<br>\n<br>\n<h2 id=\"yml-파일로-설정-나누기---간단하게\" style=\"position:relative;\"><a href=\"#yml-%ED%8C%8C%EC%9D%BC%EB%A1%9C-%EC%84%A4%EC%A0%95-%EB%82%98%EB%88%84%EA%B8%B0---%EA%B0%84%EB%8B%A8%ED%95%98%EA%B2%8C\" aria-label=\"yml 파일로 설정 나누기   간단하게 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>yml 파일로 설정 나누기 - 간단하게</h2>\n<hr>\n<br>\n<ul>\n<li><code class=\"language-text\">yml</code> 또는 <code class=\"language-text\">properties</code>를 통해서 profile 설정을 나눌 수 있다. </li>\n<li>\n<p>각각 원하는 환경에 대한 설정정보를 <code class=\"language-text\">yml</code>, <code class=\"language-text\">properties</code>에 기재한 후 <code class=\"language-text\">application-{profile-name}.yml</code> 또는 <code class=\"language-text\">application-{profile-name}.properties</code>로 지정한다. </p>\n<p align=\"center\"><img width=\"317\" alt=\"스크린샷 2021-08-17 오후 8 42 39\" src=\"https://user-images.githubusercontent.com/63405904/129719783-aeb9d93e-4c22-473e-9221-0b553393287d.png\"><br>resources 하위에 나누어진 profiles 설정들</p>\n</li>\n<li>\n<p>여러 profile 환경으로 나눠져 있을 경우 어떤 profile을 기본적으로 실행할 것인지 <code class=\"language-text\">application.properties</code>에 지정해 주어야 한다. </p>\n<div class=\"gatsby-highlight\" data-language=\"properties\"><pre class=\"language-properties\"><code class=\"language-properties\">    spring.\n        profiles.\n<span class=\"token attr-name\">            active</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">local</span></code></pre></div>\n</li>\n<li>나누어진 profile을 적용하기 위해서는 <code class=\"language-text\">$ java -jar -Dspring.profiles.active={profile-name} [jar파일명]</code>로 적용하고자하는 프로필을 지정하여 실행하거나 <code class=\"language-text\">@ActiveProfile</code> 어노테이션을 활용할 수 있다. </li>\n</ul>\n<br>\n<h3 id=\"사용-예시\" style=\"position:relative;\"><a href=\"#%EC%82%AC%EC%9A%A9-%EC%98%88%EC%8B%9C\" aria-label=\"사용 예시 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>사용 예시</h3>\n<ul>\n<li>본인은 프로젝트 진행 시 다음과 같이 local, prod, test로 환경을 나누었다. </li>\n<li>\n<p>application-local.yml</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">datasource</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> jdbc<span class=\"token punctuation\">:</span>mariadb<span class=\"token punctuation\">:</span>//localhost<span class=\"token punctuation\">:</span>3306/pickgit<span class=\"token punctuation\">?</span>serverTimezone=UTC<span class=\"token important\">&amp;characterEncoding=UTF-</span><span class=\"token number\">8</span>\n    <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> <span class=\"token important\">***</span>\n    <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> <span class=\"token important\">***</span>\n<span class=\"token key atrule\">jpa</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">show-sql</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">properties</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">hibernate</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">dialects</span><span class=\"token punctuation\">:</span> org.hibernate.dialect.MySQL57Dialect\n        <span class=\"token key atrule\">format_sql</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n        <span class=\"token key atrule\">default_batch_fetch_size</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000</span>\n    <span class=\"token key atrule\">generate-ddl</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">hibernate</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">ddl-auto</span><span class=\"token punctuation\">:</span> none</code></pre></div>\n</li>\n<li>\n<p>application-prod.yml</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">datasource</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> jdbc<span class=\"token punctuation\">:</span>mariadb<span class=\"token punctuation\">:</span>//localhost<span class=\"token punctuation\">:</span>13306/pickgit<span class=\"token punctuation\">?</span>serverTimezone=UTC<span class=\"token important\">&amp;characterEncoding=UTF-</span><span class=\"token number\">8</span>\n        <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> <span class=\"token important\">***</span>\n        <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> <span class=\"token important\">***</span>\n        <span class=\"token key atrule\">driver-class-name</span><span class=\"token punctuation\">:</span> org.mariadb.jdbc.Driver\n<span class=\"token key atrule\">jpa</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">show-sql</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">properties</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">hibernate</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">dialects</span><span class=\"token punctuation\">:</span> org.hibernate.dialect.MySQL57InnoDBDialect\n        <span class=\"token key atrule\">format_sql</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n        <span class=\"token key atrule\">default_batch_fetch_size</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000</span>\n    <span class=\"token key atrule\">generate-ddl</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">hibernate</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">ddl-auto</span><span class=\"token punctuation\">:</span> validate</code></pre></div>\n</li>\n<li>\n<p>application-test.yml</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">datasource</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> jdbc<span class=\"token punctuation\">:</span>h2<span class=\"token punctuation\">:</span>mem<span class=\"token punctuation\">:</span>~/test;MODE=MySQL;DB_CLOSE_DELAY=<span class=\"token punctuation\">-</span>1;DB_CLOSE_ON_EXIT=FALSE\n    <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> <span class=\"token important\">**</span>\n    <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> <span class=\"token important\">**</span>\n<span class=\"token key atrule\">jpa</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">show-sql</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">properties</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">hibernate</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">dialects</span><span class=\"token punctuation\">:</span> org.hibernate.dialect.MySQL57Dialect\n        <span class=\"token key atrule\">format_sql</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n        <span class=\"token key atrule\">default_batch_fetch_size</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000</span>\n    <span class=\"token key atrule\">generate-ddl</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">hibernate</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">ddl-auto</span><span class=\"token punctuation\">:</span> create<span class=\"token punctuation\">-</span>drop</code></pre></div>\n</li>\n<li>\n<p>application.yml</p>\n<ul>\n<li><code class=\"language-text\">spring.profiles.active:</code> 로 기본 profile 환경을 세팅할 수 있다. <br></li>\n<li><code class=\"language-text\">spring.profiles.include:</code> 로 포함할 다른 profile 설정을 지정할 수 있다. (주로 공통으로 적용될만한 보안 관련 profile, aws 관련 설정 등을 include로 포함한다.)</li>\n</ul>\n</li>\n</ul>\n<br>\n<br>\n<br>\n<h2 id=\"profile-어노테이션으로-환경별-설정-다르게-하기\" style=\"position:relative;\"><a href=\"#profile-%EC%96%B4%EB%85%B8%ED%85%8C%EC%9D%B4%EC%85%98%EC%9C%BC%EB%A1%9C-%ED%99%98%EA%B2%BD%EB%B3%84-%EC%84%A4%EC%A0%95-%EB%8B%A4%EB%A5%B4%EA%B2%8C-%ED%95%98%EA%B8%B0\" aria-label=\"profile 어노테이션으로 환경별 설정 다르게 하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>@Profile 어노테이션으로 환경별 설정 다르게 하기</h2>\n<hr>\n<br>\n<ul>\n<li><code class=\"language-text\">@Profile</code>을 사용하면 해당 어노테이션에서 지정한 환경으로 어플리케이션 실행 시 configuration을 설정할 수 있다. </li>\n<li>\n<p><code class=\"language-text\">@Profile</code> 어노테이션은 다음과 같이 3가지 방법으로 (더 있을 수도 있다) 사용할 수 있다. </p>\n<ol>\n<li>\n<p>@Configuration 클래스 안에 method 위에 </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">InfrastructureConfiguration</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token annotation punctuation\">@Profile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">OAuthClient</span> <span class=\"token function\">mockGithubOAuthClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MockGithubOAuthClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token annotation punctuation\">@Profile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"prod\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">OAuthClient</span> <span class=\"token function\">githubOAuthClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">GithubOAuthClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>OAuthClient 주입할 때 “test” profile 환경이면 <code class=\"language-text\">MockGithubOAuthClient</code>가 주입되고 “prod” profile 환경이면 <code class=\"language-text\">GithubOAuthClient</code>가 주입된다.\n<br></li>\n</ul>\n</li>\n<li>\n<p>@Configuration 클래스 안에 static class 위에</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">InfrastructureConfiguration</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Configuration</span>\n    <span class=\"token annotation punctuation\">@Profile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MockOAuthClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        \n        <span class=\"token annotation punctuation\">@Bean</span>\n        <span class=\"token class-name\">OAuthClient</span> <span class=\"token function\">mockGithubOAuthClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MockGithubOAuthClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Configuration</span>\n    <span class=\"token annotation punctuation\">@Profile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"prod\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MockOAuthClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        \n        <span class=\"token annotation punctuation\">@Bean</span>\n        <span class=\"token class-name\">OAuthClient</span> <span class=\"token function\">githubOAuthClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">GithubOAuthClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>중첩 클래스로도 설정할 수 있다. 보기에 가독성이 좋은 것으로 선택하면 된다.\n<br></li>\n</ul>\n</li>\n<li>\n<p>인터페이스를 구현하는 구현체 class 위에 설정 </p>\n<ul>\n<li>Bean으로 등록되어 있는 클래스에 적용할 수 있다. (<code class=\"language-text\">@Configuration</code>, <code class=\"language-text\">@Component</code>)</li>\n<li>\n<p>OAuthClient 라는 인터페이스가 있을 때, 해당 인터페이스를 구현하는 구현체를 Profile에 따라 나누어서 적용할 수 있다. </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token annotation punctuation\">@Profile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"!test\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//profile이 테스트가 아닐 경우 적용된다. </span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GithubOAuthClient</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">OAuthClient</span> <span class=\"token punctuation\">{</span>\n\n<span class=\"token comment\">//... 프로퍼티 생략</span>\n\n<span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getLoginUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://github.com/login/oauth/authorize\"</span>\n            <span class=\"token operator\">+</span> <span class=\"token string\">\"?client_id=%s\"</span>\n            <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;redirect_uri=%s\"</span>\n            <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;scope=%s\"</span><span class=\"token punctuation\">,</span>\n        clientId<span class=\"token punctuation\">,</span> redirectUrl<span class=\"token punctuation\">,</span> scope<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//... 세부 로직 생략 </span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">//... 생략 </span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p>위 로직은 Github OAuth관련 로직이므로 사용자 로그인 행위가 없는 테스트에서 실행하기 어렵기 때문에 아래와 같이 Profile이 “test”로 설정 되었을 경우 MockOAuthClient가 주입되도록 설정한다. </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token annotation punctuation\">@Profile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//profile이 테스트가 아닐 경우 적용된다. </span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MockGithubOAuthClient</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">OAuthClient</span> <span class=\"token punctuation\">{</span>\n\n<span class=\"token comment\">//... 프로퍼티 생략</span>\n\n<span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getLoginUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://github.com/login/oauth/authorize\"</span>\n            <span class=\"token operator\">+</span> <span class=\"token string\">\"?client_id=%s\"</span>\n            <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;redirect_uri=%s\"</span>\n            <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;scope=%s\"</span><span class=\"token punctuation\">,</span>\n        clientId<span class=\"token punctuation\">,</span> redirectUrl<span class=\"token punctuation\">,</span> scope<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">\"token\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">//... 생략 </span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n</li>\n</ol>\n</li>\n</ul>\n<br>\n<br>\n<br>\n<h2 id=\"activeprofile-어노테이션으로-profile-설정-적용하기\" style=\"position:relative;\"><a href=\"#activeprofile-%EC%96%B4%EB%85%B8%ED%85%8C%EC%9D%B4%EC%85%98%EC%9C%BC%EB%A1%9C-profile-%EC%84%A4%EC%A0%95-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-label=\"activeprofile 어노테이션으로 profile 설정 적용하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>@ActiveProfile 어노테이션으로 profile 설정 적용하기</h2>\n<hr>\n<br>\n<ul>\n<li>이전에 말한대로 <code class=\"language-text\">yml</code> 또는 <code class=\"language-text\">properties</code> 파일에 profile 설정을 나누고 <code class=\"language-text\">application.properties</code> 등의 파일에 profile 을 지정하거나 jar를 실행하면서 환경을 지정할 수 있다. </li>\n<li>하지만 어떤 profile 환경에서도 항상 특정 profile 환경으로 실행되어야 할 때가 있다. 예를 들어서 test 코드 같은 경우는 항상 test profile 환경으로 돌아가야한다. </li>\n<li>\n<p>이때 해당 클래스 상단에 @ActiveProfile(“test”) 등으로 설정하면 해당 profile이 적용되어 실행된다. </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@DataJpaTest</span>\n<span class=\"token annotation punctuation\">@ActiveProfiles</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">OAuthServiceIntegrationTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//...테스트 코드 생략 </span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<br>\n<br>\n</li>\n</ul>\n<p><strong>[출처]</strong></p>\n<ul>\n<li><a href=\"http://wonwoo.ml/index.php/post/1933\">http://wonwoo.ml/index.php/post/1933</a></li>\n<li><a href=\"https://www.baeldung.com/spring-profiles\">https://www.baeldung.com/spring-profiles</a></li>\n<li><a href=\"https://umanking.github.io/2019/04/13/spring-profile/\">https://umanking.github.io/2019/04/13/spring-profile/</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#intro\">Intro</a></li>\n<li>\n<p><a href=\"#yml-%ED%8C%8C%EC%9D%BC%EB%A1%9C-%EC%84%A4%EC%A0%95-%EB%82%98%EB%88%84%EA%B8%B0---%EA%B0%84%EB%8B%A8%ED%95%98%EA%B2%8C\">yml 파일로 설정 나누기 - 간단하게</a></p>\n<ul>\n<li><a href=\"#%EC%82%AC%EC%9A%A9-%EC%98%88%EC%8B%9C\">사용 예시</a></li>\n</ul>\n</li>\n<li><a href=\"#profile-%EC%96%B4%EB%85%B8%ED%85%8C%EC%9D%B4%EC%85%98%EC%9C%BC%EB%A1%9C-%ED%99%98%EA%B2%BD%EB%B3%84-%EC%84%A4%EC%A0%95-%EB%8B%A4%EB%A5%B4%EA%B2%8C-%ED%95%98%EA%B8%B0\">@Profile 어노테이션으로 환경별 설정 다르게 하기</a></li>\n<li><a href=\"#activeprofile-%EC%96%B4%EB%85%B8%ED%85%8C%EC%9D%B4%EC%85%98%EC%9C%BC%EB%A1%9C-profile-%EC%84%A4%EC%A0%95-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0\">@ActiveProfile 어노테이션으로 profile 설정 적용하기</a></li>\n</ul>\n</div>","excerpt":"Intro 프로젝트를 진행하다 보면 상황에 따라 각기 다른 운영환경을 설정해야할때가 있다. 그때마다 properties 설정 파일에 가서 설정되어있는 운영 환경을 바꾸고 돌리기는 어렵다.  이때 각기 다른 를 적용해서 상황에 따라 적합한  설정을 따르도록 할 수 있다.  yml 파일로 설정 나누기 - 간단하게  또는 를 통해서 profile 설정을 나눌 수 있다.  각각 원하는 환경에 대한 설정정보를 , 에 기재한 후  또는 로 지정한다.  여러 profile 환경으로 나눠져 있을 경우 어떤 profile을 기본적으로 실행할 것인지 에 지정해 주어야 한다.  나누어진 profile을 적용하기 위해서는 로 적용하고자하는 프로필을 지정하여 실행하거나  어노테이션을 활용할 수 있다.  사용 예시 본인은 프로젝트 진행 시 다음과 같이 local, prod, test로 환경을 나누었다.  application-local.yml application-prod.yml application-te…","frontmatter":{"date":"August 19, 2021","title":"웹 개발 시 Profile 전략 - @Profile & @ActiveProfile","categories":"스프링부트","author":"코다","emoji":"🖥"},"fields":{"slug":"/profile-active-profile/"}},"next":{"id":"24937c05-73a7-52fc-9328-64c422c66fb2","html":"<h2 id=\"intro\" style=\"position:relative;\"><a href=\"#intro\" aria-label=\"intro permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Intro</h2>\n<hr>\n<ul>\n<li>스프링부트 프로젝트를 진행하다보면 웹 mvc에 대한 테스트를 진행해야할 때가 있다. </li>\n<li>때로는 각 layer에 대한 슬라이스 테스트를 작성하거나, 일부분에 대한 통합 테스트만을 진행할 때 Mock 테스트를 해야할 때도 있다. </li>\n<li>테스트 관련 annotation에 대해서 정리하고 각 annotation의 차이 및 언제 무엇을 사용하면 좋을지 정리해본다. </li>\n</ul>\n<br>\n<br>\n<h2 id=\"code-classlanguage-textspringboottestcode\" style=\"position:relative;\"><a href=\"#code-classlanguage-textspringboottestcode\" aria-label=\"code classlanguage textspringboottestcode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">@SpringBootTest</code></h2>\n<hr>\n<br>\n<ul>\n<li><code class=\"language-text\">@SpringBootTest</code> 어노테이션은 <code class=\"language-text\">@SpringBootApplication</code> 을 찾아 해당 configuration에 맞추어 실제 Spring web context를 실행햔다. </li>\n<li>Spring context의 설정으로 그대로 적용해서 테스트를 진행해야 할 경우에 해당 어노테이션을 붙여서 테스트를 하는 것이 좋다. </li>\n<li>하지만 전체 컨텍스트를 로드하는 만큼 굉장히 오랜 시간이 걸린다. </li>\n<li>실제로 <code class=\"language-text\">@SpringBootTest</code> 어노테이션이 붙은 테스트를 돌려본다면 다음과 같은 스프링 컨텍스트르 로딩하는 긴 로그가 찍히는 것을 확인할 수 있다. </li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">//... 일부 생략\n20:37:26.255 [main] DEBUG org.springframework.test.context.support.TestPropertySourceUtils - Adding inlined properties to environment: {spring.jmx.enabled=false, org.springframework.boot.test.context.SpringBootTestContextBootstrapper=true, server.port=0}\n\n  .   ____          _            __ _ _\n /\\\\ / ___'_ __ _ _(_)_ __  __ _ \\ \\ \\ \\\n( ( )\\___ | '_ | '_| | '_ \\/ _` | \\ \\ \\ \\\n \\\\/  ___)| |_)| | | | | || (_| |  ) ) ) )\n  '  |____| .__|_| |_|_| |_\\__, | / / / /\n =========|_|==============|___/=/_/_/_/\n :: Spring Boot ::                (v2.5.2)\n\n//... 일부 생략 \n > Running with Spring Boot v2.5.2, Spring v5.3.8\n2021-08-16 20:37:26.559 DEBUG 4487 --- [           main] c.w.p.a.user.UserAcceptanceTest          : Running with Spring Boot v2.5.2, Spring v5.3.8\n2021-08-16 20:37:26.560 INFO  main o.s.boot.SpringApplication.logStartupProfileInfo L:663 \n > The following profiles are active: security,test\n2021-08-16 20:37:26.560  INFO 4487 --- [           main] c.w.p.a.user.UserAcceptanceTest          : The following profiles are active: security,test\n2021-08-16 20:37:27.252  INFO 4487 --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Bootstrapping Spring Data JPA repositories in DEFAULT mode.\n2021-08-16 20:37:27.328  INFO 4487 --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Finished Spring Data repository scanning in 70 ms. Found 4 JPA repository interfaces.\n2021-08-16 20:37:28.062  INFO 4487 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 0 (http)\n2021-08-16 20:37:28.068  INFO 4487 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]\n2021-08-16 20:37:28.068  INFO 4487 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.48]\n2021-08-16 20:37:28.115  INFO 4487 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext\n2021-08-16 20:37:28.116  INFO 4487 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 1379 ms</code></pre></div>\n<br>\n<br>\n<br>\n<h2 id=\"code-classlanguage-textautoconfiguremockmvccode\" style=\"position:relative;\"><a href=\"#code-classlanguage-textautoconfiguremockmvccode\" aria-label=\"code classlanguage textautoconfiguremockmvccode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">@AutoConfigureMockMvc</code></h2>\n<hr>\n<br>\n<ul>\n<li>위 어노테이션은 다음과 같이 <code class=\"language-text\">MockMvc</code>를 주입받아서 톰캣 서버를 띄우지 않은 상태로 API 요청 부분을 Mocking 해서 사용할 수 있다. 하지만 스프링 컨텍스트의 빈을 모두 로드하는 것은 <code class=\"language-text\">@SpringBootTest</code> 와 동일하다. </li>\n<li><code class=\"language-text\">@SpringBootTest</code> 와 <code class=\"language-text\">@AutoConfigureMockMvc</code>를 사용해서 테스트 코드를 실행해보면 위 <code class=\"language-text\">@SpringBootTest</code>를 사용했을때와 다르게 Tomcat을 시작하는 로그가 찍히지 않는 것을 확인할 수 있다. </li>\n</ul>\n<blockquote>\n<p>테스트 코드 </p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token annotation punctuation\">@AutoConfigureMockMvc</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">UserControllerTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">MockMvc</span> mockMvc<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"사용자는 내 프로필을 조회할 수 있다.\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">getAuthenticatedUserProfile_LoginUser_Success</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// given</span>\n        <span class=\"token class-name\">UserProfileResponseDto</span> responseDto <span class=\"token operator\">=</span> <span class=\"token class-name\">UserFactory</span><span class=\"token punctuation\">.</span><span class=\"token function\">mockLoginUserProfileResponseDto</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// when</span>\n        <span class=\"token class-name\">ResultActions</span> perform <span class=\"token operator\">=</span> mockMvc<span class=\"token punctuation\">.</span><span class=\"token function\">perform</span><span class=\"token punctuation\">(</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api/profiles/me\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpHeaders</span><span class=\"token punctuation\">.</span>AUTHORIZATION<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Bearer testToken\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">contentType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span>APPLICATION_JSON_VALUE<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span>ALL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">//...뒤 코드 생략</span>\n\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>실행 시 로그 </p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">//...일부 생략 \n21:41:00.201 [main] DEBUG org.springframework.test.context.support.TestPropertySourceUtils - Adding inlined properties to environment: {spring.jmx.enabled=false, org.springframework.boot.test.context.SpringBootTestContextBootstrapper=true}\n\n  .   ____          _            __ _ _\n /\\\\ / ___'_ __ _ _(_)_ __  __ _ \\ \\ \\ \\\n( ( )\\___ | '_ | '_| | '_ \\/ _` | \\ \\ \\ \\\n \\\\/  ___)| |_)| | | | | || (_| |  ) ) ) )\n  '  |____| .__|_| |_|_| |_\\__, | / / / /\n =========|_|==============|___/=/_/_/_/\n :: Spring Boot ::                (v2.5.2)\n\n//...일부 생략 \n2021-08-16 21:41:03.332  INFO 4963 --- [           main] o.s.b.t.m.w.SpringBootMockServletContext : Initializing Spring TestDispatcherServlet ''\n2021-08-16 21:41:03.333  INFO 4963 --- [           main] o.s.t.web.servlet.TestDispatcherServlet  : Initializing Servlet ''\n2021-08-16 21:41:03.334  INFO 4963 --- [           main] o.s.t.web.servlet.TestDispatcherServlet  : Completed initialization in 1 ms\n2021-08-16 21:41:03.349  INFO 4963 --- [           main] c.w.p.u.u.p.UserControllerTest           : Started UserControllerTest in 3.144 seconds (JVM running for 3.765)\n2021-08-16 21:41:03.524  INFO 4963 --- [ionShutdownHook] j.LocalContainerEntityManagerFactoryBean : Closing JPA EntityManagerFactory for persistence unit 'default'\n2021-08-16 21:41:03.525  INFO 4963 --- [ionShutdownHook] .SchemaDropperImpl$DelayedDropActionImpl : HHH000477: Starting delayed evictData of schema as part of SessionFactory shut-down'\n2021-08-16 21:41:03.532  INFO 4963 --- [ionShutdownHook] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Shutdown initiated...\n2021-08-16 21:41:03.537  INFO 4963 --- [ionShutdownHook] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Shutdown completed.</code></pre></div>\n<h2 id=\"code-classlanguage-textwebmvctestcode\" style=\"position:relative;\"><a href=\"#code-classlanguage-textwebmvctestcode\" aria-label=\"code classlanguage textwebmvctestcode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">@WebMvcTest</code></h2>\n<hr>\n<ul>\n<li><code class=\"language-text\">@WebMvcTest</code>의 경우 <code class=\"language-text\">@AutoConfigureMockMvc</code>와 비슷하게 서버가 모킹이 되지만 MVC와 관련된 빈들만 로드한다. 그렇기 때문에 MVC 관련 빈들만 사용한다면 위 어노테이션을 사용하는 것이 더 부화가 적다. </li>\n<li>\n<p>해당 어노테이션 안에 특정 클래스를 지정하면 해당 클래스와 관련한 mvc 빈들이 올라가므로 더 효율적으로 사용할 수 있다. </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@AutoConfigureRestDocs</span>\n<span class=\"token annotation punctuation\">@WebMvcTest</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">UserController</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@ActiveProfiles</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">UserControllerTest</span> <span class=\"token punctuation\">{</span>\n\n<span class=\"token annotation punctuation\">@Autowired</span>\n<span class=\"token keyword\">private</span> <span class=\"token class-name\">MockMvc</span> mockMvc<span class=\"token punctuation\">;</span>\n\n<span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"사용자는 내 프로필을 조회할 수 있다.\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">getAuthenticatedUserProfile_LoginUser_Success</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// given</span>\n    <span class=\"token class-name\">UserProfileResponseDto</span> responseDto <span class=\"token operator\">=</span> <span class=\"token class-name\">UserFactory</span><span class=\"token punctuation\">.</span><span class=\"token function\">mockLoginUserProfileResponseDto</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// when</span>\n    <span class=\"token class-name\">ResultActions</span> perform <span class=\"token operator\">=</span> mockMvc<span class=\"token punctuation\">.</span><span class=\"token function\">perform</span><span class=\"token punctuation\">(</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api/profiles/me\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpHeaders</span><span class=\"token punctuation\">.</span>AUTHORIZATION<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Bearer testToken\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">contentType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span>APPLICATION_JSON_VALUE<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span>ALL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//...뒤 코드 생략</span>\n\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p>위와 동일하게 Tomcat 관련 로그는 찍히지 않는다. 대신 <code class=\"language-text\">SpringBootMockServletContext</code>이 모킹된 서블릿을 초기화 하는 로그를 확인할 수 있다. </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">2021-08-16 23:46:28.495  INFO 5504 --- [           main] o.s.b.t.m.w.SpringBootMockServletContext : Initializing Spring TestDispatcherServlet ''\n2021-08-16 23:46:28.495  INFO 5504 --- [           main] o.s.t.web.servlet.TestDispatcherServlet  : Initializing Servlet ''\n2021-08-16 23:46:28.496  INFO 5504 --- [           main] o.s.t.web.servlet.TestDispatcherServlet  : Completed initialization in 1 ms</code></pre></div>\n<br>\n</li>\n<li>컨트롤러 슬라이스 테스트 8개에 대한 각 MockMvc 테스트를 비교했을 때, 미세하지만 <code class=\"language-text\">@WebMvcTest</code>가 더 빠른 것을 확인할 수 있다. 더 많은 숫자의 테스트 일 때 그 차이는 더 커진다.\n<br></li>\n</ul>\n<p align=\"center\"><img width=\"500\" alt=\"스크린샷 2021-08-16 오후 11 48 46\" src=\"https://user-images.githubusercontent.com/63405904/129583308-1e306f3c-0b51-4c97-8606-ee810a739289.png\">@WebMvcTest 사용</p>\n<p align=\"center\"><img width=\"598\" alt=\"스크린샷 2021-08-16 오후 11 50 11\" src=\"https://user-images.githubusercontent.com/63405904/129583673-8bd736da-f88d-407f-a894-40f1e29a94fa.png\">@AutoConfigureMockMvc 사용</p>\n<br>\n<br>\n<br>\n<h2 id=\"code-classlanguage-textextendwithmockitoextensionclasscode\" style=\"position:relative;\"><a href=\"#code-classlanguage-textextendwithmockitoextensionclasscode\" aria-label=\"code classlanguage textextendwithmockitoextensionclasscode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">@ExtendWith(MockitoExtension.class)</code></h2>\n<hr>\n<br> \n<ul>\n<li><code class=\"language-text\">@ExtendWith</code>는 JUnit에서 제공하는 기능이다. (위 테스트 어노테이션은 SpringBoot에서 제공한다.)</li>\n<li>흔히 코드에서 <code class=\"language-text\">@ExtendWith(MockitoExtension.class)</code>으로 많이 사용하고 위의 모킹과 어떠한 부분이 다른지에 대해서 많이 헷갈려한다. </li>\n<li>위 모킹은 서블릿 컨테이너에 대한 모킹을 스프링 부트 에서 제공하는 것이다. </li>\n<li><code class=\"language-text\">@ExtendWith(MockitoExtension.class)</code> 은 Mock이라는 가짜 객체를 지원하는 Mockito 테스트 프레임워크를 JUnit5와 연동하여 사용하도록 하는 것이다. (두 개의 테스트 프레임워크의 결합)</li>\n<li>주로 하나의 Layer의 단위테스트를 할 때 나머지 객체들을 모킹하도록 지원한다. </li>\n<li>즉, 서블릿 컨테이너와 상관없이 어느 한 객체에 대한 단위 테스트를 진행하면서 의존하고 있는 다른 객체의 행동을 stub하여 제어할 때 사용된다. </li>\n</ul>\n<br>\n<br>\n<br>\n<p><strong>[출처]</strong></p>\n<ul>\n<li><a href=\"https://spring.io/guides/gs/testing-web/\">https://spring.io/guides/gs/testing-web/</a></li>\n<li><a href=\"https://elevatingcodingclub.tistory.com/61\">https://elevatingcodingclub.tistory.com/61</a></li>\n<li><a href=\"https://meetup.toast.com/posts/124\">https://meetup.toast.com/posts/124</a></li>\n<li><a href=\"https://www.baeldung.com/spring-boot-testing\">https://www.baeldung.com/spring-boot-testing</a></li>\n<li><a href=\"https://junit.org/junit5/docs/current/user-guide/#extensions\">https://junit.org/junit5/docs/current/user-guide/#extensions</a></li>\n<li><a href=\"https://pinokio0702.tistory.com/143\">https://pinokio0702.tistory.com/143</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#intro\">Intro</a></li>\n<li><a href=\"#springboottest\"><code class=\"language-text\">@SpringBootTest</code></a></li>\n<li><a href=\"#autoconfiguremockmvc\"><code class=\"language-text\">@AutoConfigureMockMvc</code></a></li>\n<li><a href=\"#webmvctest\"><code class=\"language-text\">@WebMvcTest</code></a></li>\n<li><a href=\"#extendwithmockitoextensionclass\"><code class=\"language-text\">@ExtendWith(MockitoExtension.class)</code></a></li>\n</ul>\n</div>","frontmatter":{"date":"August 17, 2021","title":"Springboot 언제 어떤 테스트를 사용할까","categories":"스프링부트 테스트","author":"코다","emoji":"🖥"},"fields":{"slug":"/spring-boot-test/"}},"prev":{"id":"7bad748d-3789-5403-bce9-4bf2f8205619","html":"<h2 id=\"intro\" style=\"position:relative;\"><a href=\"#intro\" aria-label=\"intro permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>INTRO</h2>\n<ul>\n<li>JPA에서는 데이터와 객체지향으로 설계 사이의 모순을 해소하기 위해서 나온 기술이다. </li>\n<li>\n<p>많은 객체들은 내부에 Collection 형태로 다른 객체에 대한 참조가 가능하게 설계된다. </p>\n<ul>\n<li>예) <code class=\"language-text\">Team</code> 객체 내부에 <code class=\"language-text\">Team</code>에 속해있는 <code class=\"language-text\">List&lt;Member></code> 와 팀에 할당된 <code class=\"language-text\">List&lt;Locker></code>가 존재한다. </li>\n</ul>\n</li>\n<li>\n<p>이때 상위 객체를 select 하면서 하위 객체를 가져오는 경우 다음 두가지 fetch 타입에 각각 다음과 같은 문제가 있다. </p>\n<ul>\n<li><code class=\"language-text\">fetch = FetchType.EAGER</code>일 경우 : <code class=\"language-text\">MultipleBagFetchException</code>이 발생</li>\n<li><code class=\"language-text\">fetch = FetchType.LAZY</code>일 경우 : <code class=\"language-text\">N+1</code> 문제 발생</li>\n</ul>\n</li>\n<li>상위 엔티티에서 다수의 collection 형태의 연관엔티티를 가지고 있을 때 여러 상황 및 문제와 해결 방법에 대해서 공부해본다. </li>\n</ul>\n<br>\n<h2 id=\"entity-상황\" style=\"position:relative;\"><a href=\"#entity-%EC%83%81%ED%99%A9\" aria-label=\"entity 상황 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Entity 상황</h2>\n<ul>\n<li><code class=\"language-text\">Team</code>과 <code class=\"language-text\">Member</code>가 1:N 연관관계 - <code class=\"language-text\">FetchType.LAZY</code>, <code class=\"language-text\">cascadeType.PERSIST</code></li>\n<li><code class=\"language-text\">Team</code>과 <code class=\"language-text\">Locker</code>가 1:N 연관관계 - <code class=\"language-text\">FetchType.LAZY</code>, <code class=\"language-text\">cascadeType.PERSIST</code></li>\n<li>참고 : 우선 모든 연관관계는 <code class=\"language-text\">LAZY</code>로 적용하고 테스트 상황에 따라 <code class=\"language-text\">EAGER</code>로 변경</li>\n<li>\n<p><code class=\"language-text\">Team</code> 엔티티</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Team</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span> <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span>IDENTITY<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@OneToMany</span><span class=\"token punctuation\">(</span>\n        mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"team\"</span><span class=\"token punctuation\">,</span>\n        cascade <span class=\"token operator\">=</span> <span class=\"token class-name\">CascadeType</span><span class=\"token punctuation\">.</span>PERSIST<span class=\"token punctuation\">,</span>\n        fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span>EAGER<span class=\"token punctuation\">,</span>\n        orphanRemoval <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> members <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@OneToMany</span><span class=\"token punctuation\">(</span>\n        mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"team\"</span><span class=\"token punctuation\">,</span>\n        cascade <span class=\"token operator\">=</span> <span class=\"token class-name\">CascadeType</span><span class=\"token punctuation\">.</span>PERSIST<span class=\"token punctuation\">,</span>\n        fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span>EAGER<span class=\"token punctuation\">,</span>\n        orphanRemoval <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Locker</span><span class=\"token punctuation\">></span></span> lockers<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token class-name\">Team</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//...생성자 생략 </span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">addLocker</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Locker</span> locker<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        locker<span class=\"token punctuation\">.</span><span class=\"token function\">setTeam</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        lockers<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>locker<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setMembers</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> members<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        members<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>member <span class=\"token operator\">-></span> member<span class=\"token punctuation\">.</span><span class=\"token function\">setTeam</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>members <span class=\"token operator\">=</span> members<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//...getter 생략</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p><code class=\"language-text\">Member</code> 엔티티</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span> <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span>IDENTITY<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@ManyToOne</span><span class=\"token punctuation\">(</span>fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span>LAZY<span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"team_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Team</span> team<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//생성자 및 setter, getter 생략</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p><code class=\"language-text\">Locker</code> 엔티티</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Locker</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span> <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span>IDENTITY<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@ManyToOne</span>\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"team_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Team</span> team<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token class-name\">Locker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//생성자 및 setter, getter 생략</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<br>\n<h2 id=\"jpa에서-collection-fetch-join\" style=\"position:relative;\"><a href=\"#jpa%EC%97%90%EC%84%9C-collection-fetch-join\" aria-label=\"jpa에서 collection fetch join permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JPA에서 collection fetch join</h2>\n<ul>\n<li>Team에 대한 모든 정보가 필요한 경우 Team을 가져오면서 Members와 Lockers 정보도 모두 함께 가지고 와야하는 경우가 있을 수 있다. </li>\n<li>\n<p>JPA에서는 <code class=\"language-text\">OneToMany</code>관계에서 fetch join을 할 경우 중복 데이터가 발생한다. 따라서 해결을 하기 위해서 쿼리에 <code class=\"language-text\">distinct</code>를 추가해주어 중복을 없애야한다. </p>\n<ol>\n<li>\n<p><code class=\"language-text\">distinct</code>가 없는 collection fetch join</p>\n<ul>\n<li>\n<p>TeamRepository.java</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select t from Team t join fetch t.members\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Team</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllJoinFetchMembers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">distinct</code> 있는 collection fetch join</p>\n<ul>\n<li>\n<p>TeamRepository.java</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select distinct t from Team t join fetch t.members\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Team</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllJoinFetchMembers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n</li>\n</ul>\n</li>\n<li>\n<p>실제 실행된 query </p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span>\n    team0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_2_0_<span class=\"token punctuation\">,</span>\n    members1_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_1_1_<span class=\"token punctuation\">,</span>\n    team0_<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name2_2_0_<span class=\"token punctuation\">,</span>\n    members1_<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name2_1_1_<span class=\"token punctuation\">,</span>\n    members1_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_1_1_<span class=\"token punctuation\">,</span>\n    members1_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_1_0__<span class=\"token punctuation\">,</span>\n    members1_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_1_0__ \n<span class=\"token keyword\">from</span>\n    team team0_ \n<span class=\"token keyword\">inner</span> <span class=\"token keyword\">join</span>\n    member members1_ \n        <span class=\"token keyword\">on</span> team0_<span class=\"token punctuation\">.</span>id<span class=\"token operator\">=</span>members1_<span class=\"token punctuation\">.</span>team_id</code></pre></div>\n<br>\n</li>\n<li>\n<p>Test Method </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@BeforeEach</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">setUp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Team</span> teamA <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Team</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"teamA\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    teamA<span class=\"token punctuation\">.</span><span class=\"token function\">addLocker</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Locker</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"L1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    teamA<span class=\"token punctuation\">.</span><span class=\"token function\">addLocker</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Locker</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"L2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Team</span> teamB <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Team</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"teamB\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    teamB<span class=\"token punctuation\">.</span><span class=\"token function\">addLocker</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Locker</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"L3\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    teamB<span class=\"token punctuation\">.</span><span class=\"token function\">addLocker</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Locker</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"L4\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Member</span> memberA1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"memberA1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Member</span> memberA2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"memberA2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Member</span> memberA3 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"memberA3\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Member</span> memberB1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"memberB1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Member</span> memberB2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"memberB2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Member</span> memberB3 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"memberB3\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> teamAMembers <span class=\"token operator\">=</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>memberA1<span class=\"token punctuation\">,</span> memberA2<span class=\"token punctuation\">,</span> memberA3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> teamBMembers <span class=\"token operator\">=</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>memberB1<span class=\"token punctuation\">,</span> memberB2<span class=\"token punctuation\">,</span> memberB3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    teamA<span class=\"token punctuation\">.</span><span class=\"token function\">setMembers</span><span class=\"token punctuation\">(</span>teamAMembers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    teamB<span class=\"token punctuation\">.</span><span class=\"token function\">setMembers</span><span class=\"token punctuation\">(</span>teamBMembers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    teamRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>teamA<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    teamRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>teamB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    testEntityManager<span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    testEntityManager<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"collection fetch join 데이터에 대해 데이터 뻥튀기가 발생한다.\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">collectionFetchJoin_DuplicatedDataSelected</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Team</span><span class=\"token punctuation\">></span></span> teams <span class=\"token operator\">=</span> teamRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//members와 lockers가 지연로딩이므로 select 쿼리 1개</span>\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>teams<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    testEntityManager<span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    testEntityManager<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"======================================\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Team</span><span class=\"token punctuation\">></span></span> teamsWithMembers <span class=\"token operator\">=</span> teamRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAllJoinFetchMembers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>teamsWithMembers<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// members에 대한 fetch join을 할 경우(distinct 없음) 데이터 뻥튀기가 발생한다.</span>\n\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Team</span><span class=\"token punctuation\">></span></span> teamsWithMembers <span class=\"token operator\">=</span> teamRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAllJoinFetchMembers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>teamsWithMembers<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// members에 대한 fetch join을 할 경우(distinct 있음) 데이터 중복이 일어나지 않는다.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ol>\n</li>\n</ul>\n<br>\n<h2 id=\"code-classlanguage-textfetchtypeeagercode---code-classlanguage-textmultiplebagfetchexceptioncode-발생\" style=\"position:relative;\"><a href=\"#code-classlanguage-textfetchtypeeagercode---code-classlanguage-textmultiplebagfetchexceptioncode-%EB%B0%9C%EC%83%9D\" aria-label=\"code classlanguage textfetchtypeeagercode   code classlanguage textmultiplebagfetchexceptioncode 발생 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">FetchType.EAGER</code> - <code class=\"language-text\">MultipleBagFetchException</code> 발생</h2>\n<ul>\n<li>현재는 위에 연관관계 fetchType이 <code class=\"language-text\">LAZY</code>로 되어 있지만 두 가지를 <code class=\"language-text\">EAGER</code>로 설정하여 즉시로딩 할 경우 <code class=\"language-text\">MultipleBagFetchExcpetion</code>이 발생한다. </li>\n<li>JPA에서는 다수의 <code class=\"language-text\">OneToMany</code>로 연관관계가 맺어져 있는 연관 엔티티에 대한 즉시로딩을 막고 있는데, 위에서 언급한 컬렉션 즉시로딩 시 발생하는 데이터 뻥튀기에 대한 제어가 어렵기 때문이다. </li>\n<li>발생 예외 - <br>\n<code class=\"language-text\">Caused by: org.hibernate.loader.MultipleBagFetchException: cannot simultaneously fetch multiple bags:</code> </li>\n</ul>\n<br>\n<h2 id=\"code-classlanguage-textfetchtypelazycode---code-classlanguage-textn1-문제code-발생\" style=\"position:relative;\"><a href=\"#code-classlanguage-textfetchtypelazycode---code-classlanguage-textn1-%EB%AC%B8%EC%A0%9Ccode-%EB%B0%9C%EC%83%9D\" aria-label=\"code classlanguage textfetchtypelazycode   code classlanguage textn1 문제code 발생 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">FetchType.LAZY</code> - <code class=\"language-text\">N+1 문제</code> 발생</h2>\n<ul>\n<li><code class=\"language-text\">Team</code>의 <code class=\"language-text\">Member</code>와 <code class=\"language-text\">Locker</code>가 각각 <code class=\"language-text\">OneToMany</code> 연관관계가 맺어져 있다. </li>\n<li>다음과 같이 메소드를 실행 할 때 N + 1 쿼리가 발생한다. </li>\n<li>\n<p>실행 서비스 로직</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Team의 Members, Lockers 관련 서비스 로직이 있을 때 N+1 문제가 발생한다.\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">findAll_TooManyQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Team</span><span class=\"token punctuation\">></span></span> teams <span class=\"token operator\">=</span> teamRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//모든 teams를 조회하는 select 쿼리 1개가 발생한다.</span>\n\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> memberNames <span class=\"token operator\">=</span> teams<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//각 팀 A개에 대한 각각의 Member select 쿼리 N개가 발생한다.</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Team</span><span class=\"token operator\">::</span><span class=\"token function\">getMembers</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">flatMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collection</span><span class=\"token operator\">::</span><span class=\"token function\">stream</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Member</span><span class=\"token operator\">::</span><span class=\"token function\">getName</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> lockerNums <span class=\"token operator\">=</span> teams<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//각 팀 A개에 대한 각각의 Locker select 쿼리 N개가 발생한다.</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Team</span><span class=\"token operator\">::</span><span class=\"token function\">getLockers</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">flatMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collection</span><span class=\"token operator\">::</span><span class=\"token function\">stream</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Locker</span><span class=\"token operator\">::</span><span class=\"token function\">getName</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>teams<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>memberNames<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>lockerNums<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p>실제 발생 쿼리</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\">Hibernate: <span class=\"token comment\">#Team 전체 조회</span>\n<span class=\"token keyword\">select</span>\n    team0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_2_<span class=\"token punctuation\">,</span>\n    team0_<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name2_2_ \n<span class=\"token keyword\">from</span>\n    team team0_\nHibernate: <span class=\"token comment\">#첫번째 Team의 Member 조회</span>\n    <span class=\"token keyword\">select</span> \n        members0_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_1_0_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_1_0_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_1_1_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name2_1_1_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_1_1_ \n    <span class=\"token keyword\">from</span>\n        member members0_ \n    <span class=\"token keyword\">where</span>\n        members0_<span class=\"token punctuation\">.</span>team_id<span class=\"token operator\">=</span>?\n\nHibernate: <span class=\"token comment\">#두번째 Team의 Member 조회</span>\n    <span class=\"token keyword\">select</span>\n        members0_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_1_0_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_1_0_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_1_1_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name2_1_1_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_1_1_ \n    <span class=\"token keyword\">from</span>\n        member members0_ \n    <span class=\"token keyword\">where</span>\n        members0_<span class=\"token punctuation\">.</span>team_id<span class=\"token operator\">=</span>?\n\nHibernate: <span class=\"token comment\">#첫번째 Team의 Locker 조회</span>\n    <span class=\"token keyword\">select</span>\n        lockers0_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_0_0_<span class=\"token punctuation\">,</span>\n        lockers0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_0_0_<span class=\"token punctuation\">,</span>\n        lockers0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_0_1_<span class=\"token punctuation\">,</span>\n        lockers0_<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name2_0_1_<span class=\"token punctuation\">,</span>\n        lockers0_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_0_1_ \n    <span class=\"token keyword\">from</span>\n        locker lockers0_ \n    <span class=\"token keyword\">where</span>\n        lockers0_<span class=\"token punctuation\">.</span>team_id<span class=\"token operator\">=</span>?\n\nHibernate: <span class=\"token comment\">#두번째 Team의 Locker 조회</span>\n    <span class=\"token keyword\">select</span>\n        lockers0_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_0_0_<span class=\"token punctuation\">,</span>\n        lockers0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_0_0_<span class=\"token punctuation\">,</span>\n        lockers0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_0_1_<span class=\"token punctuation\">,</span>\n        lockers0_<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name2_0_1_<span class=\"token punctuation\">,</span>\n        lockers0_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_0_1_ \n    <span class=\"token keyword\">from</span>\n        locker lockers0_ \n    <span class=\"token keyword\">where</span>\n        lockers0_<span class=\"token punctuation\">.</span>team_id<span class=\"token operator\">=</span>?</code></pre></div>\n</li>\n<li><code class=\"language-text\">Team</code>을 전체 조회할 때 지연로딩으로 인해 각 <code class=\"language-text\">Team</code> 마다 <code class=\"language-text\">Member</code> 조회 쿼리, <code class=\"language-text\">Locker</code> 조회 쿼리가 팀의 개수 N 만큼 추가로 나가므로 <code class=\"language-text\">N+1 문제</code>가 발생한 것이다.</li>\n<li>팀의 개수가 많으면 많을수록 추가적인 쿼리가 많이 나가 성능이 더욱 떨어진다. </li>\n<li>해결하기 위해서는 연관관계 엔티티를 즉시로딩하거나 비슷한 방법을 사용하여 적은 쿼리로 select 할 수 있도록 해야한다.  </li>\n</ul>\n<br>\n<h3 id=\"하나의-collection-code-classlanguage-textfetch-joincode을-할-경우\" style=\"position:relative;\"><a href=\"#%ED%95%98%EB%82%98%EC%9D%98-collection-code-classlanguage-textfetch-joincode%EC%9D%84-%ED%95%A0-%EA%B2%BD%EC%9A%B0\" aria-label=\"하나의 collection code classlanguage textfetch joincode을 할 경우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>하나의 collection <code class=\"language-text\">fetch join</code>을 할 경우</h3>\n<ul>\n<li>우선 하나의 Collection이라도 <code class=\"language-text\">fetch join</code> 한다면 어떻게 동작이 될까? </li>\n<li>\n<p>Team을 조회할 때 다음과 같은 쿼리를 사용해서 Lockers 컬렉션만 join fetch 하도록 한다. </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select distinct t from Team t join fetch t.lockers\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Team</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllJoinFetchLockers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n</li>\n<li>실행 서비스 로직은 바로 위와 같고, teams를 조회할 때문 위의 쿼리를 사용했다. </li>\n<li>\n<p>실제 발생 쿼리</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\">Hibernate: <span class=\"token comment\">#전체 팀 조회 시 lockers를 join fetch 한다. </span>\n<span class=\"token keyword\">select</span>\n    <span class=\"token keyword\">distinct</span> team0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_2_0_<span class=\"token punctuation\">,</span>\n    lockers1_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_0_1_<span class=\"token punctuation\">,</span>\n    team0_<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name2_2_0_<span class=\"token punctuation\">,</span>\n    lockers1_<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name2_0_1_<span class=\"token punctuation\">,</span>\n    lockers1_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_0_1_<span class=\"token punctuation\">,</span>\n    lockers1_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_0_0__<span class=\"token punctuation\">,</span>\n    lockers1_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_0_0__ \n<span class=\"token keyword\">from</span>\n    team team0_ \n<span class=\"token keyword\">inner</span> <span class=\"token keyword\">join</span>\n    locker lockers1_ \n        <span class=\"token keyword\">on</span> team0_<span class=\"token punctuation\">.</span>id<span class=\"token operator\">=</span>lockers1_<span class=\"token punctuation\">.</span>team_id\n\nHibernate: <span class=\"token comment\">#첫번째 Team의 Member 조회</span>\n    <span class=\"token keyword\">select</span>\n        members0_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_1_0_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_1_0_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_1_1_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name2_1_1_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_1_1_ \n    <span class=\"token keyword\">from</span>\n        member members0_ \n    <span class=\"token keyword\">where</span>\n        members0_<span class=\"token punctuation\">.</span>team_id<span class=\"token operator\">=</span>?\n\n    <span class=\"token keyword\">select</span> <span class=\"token comment\">#두번째 Team의 Member 조회</span>\n        members0_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_1_0_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_1_0_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_1_1_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name2_1_1_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_1_1_ \n    <span class=\"token keyword\">from</span>\n        member members0_ \n    <span class=\"token keyword\">where</span>\n        members0_<span class=\"token punctuation\">.</span>team_id<span class=\"token operator\">=</span>?</code></pre></div>\n<ul>\n<li>Lockers 컬렉션을 join fetch 해서 즉시로딩 했으니, lockers 컬렉션 관련 서비스 로직 실행 시 추가 쿼리는 발생하지 않았다. </li>\n<li>여전히 Members에 대해서는 team N개 만큼의 추가 쿼리 N개가 발생했다. </li>\n<li>어느정도 쿼리가 줄긴 했으나, 여젼히 <code class=\"language-text\">N+1 문제</code>가 발생하고 있다. </li>\n</ul>\n</li>\n</ul>\n<br>\n<br>\n<h2 id=\"다수의-collection-code-classlanguage-textfetch-joincode을-할-경우---code-classlanguage-textmutiplebagfetchexceptioncode-발생\" style=\"position:relative;\"><a href=\"#%EB%8B%A4%EC%88%98%EC%9D%98-collection-code-classlanguage-textfetch-joincode%EC%9D%84-%ED%95%A0-%EA%B2%BD%EC%9A%B0---code-classlanguage-textmutiplebagfetchexceptioncode-%EB%B0%9C%EC%83%9D\" aria-label=\"다수의 collection code classlanguage textfetch joincode을 할 경우   code classlanguage textmutiplebagfetchexceptioncode 발생 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>다수의 collection <code class=\"language-text\">fetch join</code>을 할 경우 - <code class=\"language-text\">MutipleBagFetchException</code> 발생</h2>\n<ul>\n<li>그렇다면 두 개의 컬렉션을 모두 fetch join 한다면 쿼리를 최적화 할 수 있지 않을까 생각할 수 있다. </li>\n<li>하지만 두개의 OneToMany 연관관계에 있는 collection fetch join을 할 경우 <code class=\"language-text\">MutipleBagFetchException</code> 예외가 발생한다. </li>\n<li>\n<p>두개의 collection을 fetch join 하는 JPQL</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select distinct t from Team t join fetch t.members join fetch t.lockers\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Team</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllJoinFetchAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n</li>\n<li>발생 예외 - <br>\n<code class=\"language-text\">Caused by: org.hibernate.loader.MultipleBagFetchException: cannot simultaneously fetch multiple bags:</code> </li>\n<li>collection을 <code class=\"language-text\">fetch join</code> 하면서 데이터 뻥튀기가 일어나기 때문인데 두 개 이상의 컬렉션을 할 경우 그 복잡도가 높아지기 때문에 JPA에서는 예외로 처리한다. </li>\n<li>위 쿼리를 실행하기도 전에 <code class=\"language-text\">JPA Entity Manager</code>에서 오류를 발견하여 어플리케이션 실행 시작 당시 <code class=\"language-text\">Bean Creation</code> 단계에서 예외를 던져 어플리케이션이 실행되지 못하게 한다. </li>\n</ul>\n<br>\n<br>\n<h2 id=\"또-다른-문제-jpa-pagination\" style=\"position:relative;\"><a href=\"#%EB%98%90-%EB%8B%A4%EB%A5%B8-%EB%AC%B8%EC%A0%9C-jpa-pagination\" aria-label=\"또 다른 문제 jpa pagination permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>또 다른 문제, JPA Pagination</h2>\n<ul>\n<li>위와 같은 서비스 로직을 실행할 때 뿐 아니라 JPA Pagination을 적용하려고 할 때 collection fetch join의 문제가 발생한다. </li>\n<li>collection fetch 를 할 경우 데이터 뻥튀기가 발생하기 때문에 Paging에 애매하게 되기 때문에 <code class=\"language-text\">select</code> 할 때 <code class=\"language-text\">WARN</code>이 발생한다.\n<br></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"log\"><pre class=\"language-log\"><code class=\"language-log\"><span class=\"token date number\">2021-08-22</span> <span class=\"token time number\">22:04:27.898</span>  <span class=\"token level warning important\">WARN</span> <span class=\"token number\">4825</span> <span class=\"token separator comment\">---</span> <span class=\"token punctuation\">[</span>    Test worker<span class=\"token punctuation\">]</span> o<span class=\"token punctuation\">.</span>h<span class=\"token punctuation\">.</span>h<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>ast<span class=\"token punctuation\">.</span>QueryTranslatorImpl   <span class=\"token operator\">:</span> HHH000104<span class=\"token operator\">:</span> firstResult<span class=\"token operator\">/</span>maxResults specified with collection fetch<span class=\"token operator\">;</span> applying in memory<span class=\"token operator\">!</span>\n<span class=\"token property\">Hibernate:</span> \n    select\n        distinct team0_<span class=\"token punctuation\">.</span>id as id1_2_0_<span class=\"token punctuation\">,</span>\n        members1_<span class=\"token punctuation\">.</span>id as id1_1_1_<span class=\"token punctuation\">,</span>\n        team0_<span class=\"token punctuation\">.</span>name as name2_2_0_<span class=\"token punctuation\">,</span>\n        members1_<span class=\"token punctuation\">.</span>name as name2_1_1_<span class=\"token punctuation\">,</span>\n        members1_<span class=\"token punctuation\">.</span>team_id as team_id3_1_1_<span class=\"token punctuation\">,</span>\n        members1_<span class=\"token punctuation\">.</span>team_id as team_id3_1_0__<span class=\"token punctuation\">,</span>\n        members1_<span class=\"token punctuation\">.</span>id as id1_1_0__ \n    from\n        team team0_ \n    inner join\n        member members1_ \n            on team0_<span class=\"token punctuation\">.</span>id<span class=\"token operator\">=</span>members1_<span class=\"token punctuation\">.</span>team_id</code></pre></div>\n<ul>\n<li>그렇기 때문에 Pageable을 적용하면서 N+1 문제에 대해 <code class=\"language-text\">fetch join</code>만을 사용해서 해결하기는 어렵다.</li>\n</ul>\n<br>\n<br>\n<h2 id=\"해결방법-batchsize-적용하기\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0%EB%B0%A9%EB%B2%95-batchsize-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-label=\"해결방법 batchsize 적용하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결방법: BatchSize 적용하기</h2>\n<ul>\n<li>위 문제를 해결할 수 있는 방법 중 하나는 BatchSize를 적용하는 것이다. </li>\n<li><code class=\"language-text\">spring.jpa.properties.hibernate.default_batch_fetch_size={batchSize}</code> 를 <code class=\"language-text\">application.properties</code>에 지정하면 설정된 Batch Size만큼 <code class=\"language-text\">IN</code> 쿼리로 날라간다. </li>\n<li>\n<p>위와 동일한 테스트 코드 실행 (Pagination을 추가한 것 외에는 동일히다.)</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Batch size를 적용해 Pagination을 하면 N+1문제나 경고가 뜨지 않는다.\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">findWithPagination</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Pageable</span> pageable <span class=\"token operator\">=</span> <span class=\"token class-name\">PageRequest</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Team</span><span class=\"token punctuation\">></span></span> teams <span class=\"token operator\">=</span> teamRepository\n        <span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span>pageable<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> memberNames <span class=\"token operator\">=</span> teams<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//최대 batch size만큼 IN 쿼리로 한번에 처리된다</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Team</span><span class=\"token operator\">::</span><span class=\"token function\">getMembers</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">flatMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collection</span><span class=\"token operator\">::</span><span class=\"token function\">stream</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Member</span><span class=\"token operator\">::</span><span class=\"token function\">getName</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> lockerNums <span class=\"token operator\">=</span> teams<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//최대 batch size만큼 IN 쿼리로 한번에 처리된다</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Team</span><span class=\"token operator\">::</span><span class=\"token function\">getLockers</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">flatMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collection</span><span class=\"token operator\">::</span><span class=\"token function\">stream</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Locker</span><span class=\"token operator\">::</span><span class=\"token function\">getName</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>teams<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>memberNames<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>lockerNums<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p>실제 실행된 쿼리</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\">Hibernate: <span class=\"token comment\"># 전체 팀 조회 쿼리</span>\n<span class=\"token keyword\">select</span>\n    team0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_2_<span class=\"token punctuation\">,</span>\n    team0_<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name2_2_ \n<span class=\"token keyword\">from</span>\n    team team0_ <span class=\"token keyword\">limit</span> ?\nHibernate: \n    <span class=\"token keyword\">select</span>\n        <span class=\"token function\">count</span><span class=\"token punctuation\">(</span>team0_<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> col_0_0_ \n    <span class=\"token keyword\">from</span>\n        team team0_\nHibernate: <span class=\"token comment\"># Team 2개의 Id가 IN 절로 한번에 조회된다. </span>\n    <span class=\"token keyword\">select</span>\n        members0_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_1_1_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_1_1_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_1_0_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name2_1_0_<span class=\"token punctuation\">,</span>\n        members0_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_1_0_ \n    <span class=\"token keyword\">from</span>\n        member members0_ \n    <span class=\"token keyword\">where</span>\n        members0_<span class=\"token punctuation\">.</span>team_id <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span>\n            ?<span class=\"token punctuation\">,</span> ?\n        <span class=\"token punctuation\">)</span>\n<span class=\"token number\">2021</span><span class=\"token operator\">-</span><span class=\"token number\">08</span><span class=\"token operator\">-</span><span class=\"token number\">23</span> <span class=\"token number\">02</span>:<span class=\"token number\">41</span>:<span class=\"token number\">39.149</span> TRACE <span class=\"token number\">5511</span> <span class=\"token comment\">--- [    Test worker] o.h.type.descriptor.sql.BasicBinder      : binding parameter [1] as [BIGINT] - [1]</span>\n<span class=\"token number\">2021</span><span class=\"token operator\">-</span><span class=\"token number\">08</span><span class=\"token operator\">-</span><span class=\"token number\">23</span> <span class=\"token number\">02</span>:<span class=\"token number\">41</span>:<span class=\"token number\">39.149</span> TRACE <span class=\"token number\">5511</span> <span class=\"token comment\">--- [    Test worker] o.h.type.descriptor.sql.BasicBinder      : binding parameter [2] as [BIGINT] - [2]</span>\nHibernate: <span class=\"token comment\"># Team 2개의 Id가 IN 절로 한번에 조회된다. </span>\n    <span class=\"token keyword\">select</span>\n        lockers0_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_0_1_<span class=\"token punctuation\">,</span>\n        lockers0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_0_1_<span class=\"token punctuation\">,</span>\n        lockers0_<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id1_0_0_<span class=\"token punctuation\">,</span>\n        lockers0_<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name2_0_0_<span class=\"token punctuation\">,</span>\n        lockers0_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_0_0_ \n    <span class=\"token keyword\">from</span>\n        locker lockers0_ \n    <span class=\"token keyword\">where</span>\n        lockers0_<span class=\"token punctuation\">.</span>team_id <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span>\n            ?<span class=\"token punctuation\">,</span> ?\n        <span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n<li>이전에는 전체 팀 조회 쿼리 1개 + Team 2개에 대한 Members 조회 쿼리 2개 + Team 2개에 대한 Lockers 조회 쿼리 2개해서 총 5개의 쿼리가 나갔다. </li>\n<li>Batch size를 적용한 이후에는 전체 팀 조회 쿼리 1개 + Team의 Members 조회 쿼리 1개 + Team의 Lockers 조회 쿼리 1개 총 2개의 쿼리가 나갔다. </li>\n<li>Team의 사이즈가 클 수록 더 쿼리 차이가 많이 난다. </li>\n<li>Batch size는 1000을 넘어가지 않도록 설정하는 것이 좋다.</li>\n</ul>\n<br>\n<br>\n<br>\n<p><strong>[참고자료]</strong></p>\n<ul>\n<li><a href=\"https://jojoldu.tistory.com/457\">https://jojoldu.tistory.com/457</a></li>\n<li><a href=\"https://www.inflearn.com/questions/14663\">https://www.inflearn.com/questions/14663</a></li>\n<li><a href=\"https://jojoldu.tistory.com/165\">https://jojoldu.tistory.com/165</a></li>\n<li><a href=\"https://woowacourse.github.io/tecoble/post/2021-07-26-jpa-pageable/\">https://woowacourse.github.io/tecoble/post/2021-07-26-jpa-pageable/</a> </li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#intro\">INTRO</a></li>\n<li><a href=\"#entity-%EC%83%81%ED%99%A9\">Entity 상황</a></li>\n<li><a href=\"#jpa%EC%97%90%EC%84%9C-collection-fetch-join\">JPA에서 collection fetch join</a></li>\n<li><a href=\"#fetchtypeeager---multiplebagfetchexception-%EB%B0%9C%EC%83%9D\"><code class=\"language-text\">FetchType.EAGER</code> - <code class=\"language-text\">MultipleBagFetchException</code> 발생</a></li>\n<li>\n<p><a href=\"#fetchtypelazy---n1-%EB%AC%B8%EC%A0%9C-%EB%B0%9C%EC%83%9D\"><code class=\"language-text\">FetchType.LAZY</code> - <code class=\"language-text\">N+1 문제</code> 발생</a></p>\n<ul>\n<li><a href=\"#%ED%95%98%EB%82%98%EC%9D%98-collection-fetch-join%EC%9D%84-%ED%95%A0-%EA%B2%BD%EC%9A%B0\">하나의 collection <code class=\"language-text\">fetch join</code>을 할 경우</a></li>\n</ul>\n</li>\n<li><a href=\"#%EB%8B%A4%EC%88%98%EC%9D%98-collection-fetch-join%EC%9D%84-%ED%95%A0-%EA%B2%BD%EC%9A%B0---mutiplebagfetchexception-%EB%B0%9C%EC%83%9D\">다수의 collection <code class=\"language-text\">fetch join</code>을 할 경우 - <code class=\"language-text\">MutipleBagFetchException</code> 발생</a></li>\n<li><a href=\"#%EB%98%90-%EB%8B%A4%EB%A5%B8-%EB%AC%B8%EC%A0%9C-jpa-pagination\">또 다른 문제, JPA Pagination</a></li>\n<li><a href=\"#%ED%95%B4%EA%B2%B0%EB%B0%A9%EB%B2%95-batchsize-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0\">해결방법: BatchSize 적용하기</a></li>\n</ul>\n</div>","frontmatter":{"date":"August 26, 2021","title":"JPA N+1 문제 및 해결방법 알아보기","categories":"JPA","author":"코다","emoji":"🚀"},"fields":{"slug":"/jpa-query-bug/"}},"site":{"siteMetadata":{"siteUrl":"https://yjksw.github.io","comments":{"utterances":{"repo":"yjksw/yjksw.github.io"}}}}},"pageContext":{"slug":"/profile-active-profile/","nextSlug":"/spring-boot-test/","prevSlug":"/jpa-query-bug/"}},"staticQueryHashes":["1073350324","2938748437"]}